/*
    ZORBOX - Basic Malware Detection Rules
    Hackathon MVP Sample Rules
*/

rule Packed_UPX {
    meta:
        description = "Detects UPX packed executables"
        severity = "medium"
        category = "packer"
    strings:
        $upx1 = "UPX0" ascii
        $upx2 = "UPX1" ascii
        $upx3 = "UPX!" ascii
    condition:
        uint16(0) == 0x5A4D and any of ($upx*)
}

rule Suspicious_PowerShell_Base64 {
    meta:
        description = "Detects PowerShell scripts with Base64 encoding"
        severity = "high"
        category = "script"
    strings:
        $enc1 = "-enc" nocase ascii
        $enc2 = "-EncodedCommand" nocase ascii
        $enc3 = "FromBase64String" nocase ascii
        $iex = "IEX" nocase ascii
        $invoke = "Invoke-Expression" nocase ascii
    condition:
        any of ($enc*) and (any of ($iex, $invoke))
}

rule Suspicious_CreateRemoteThread {
    meta:
        description = "Detects potential process injection via CreateRemoteThread"
        severity = "high"
        category = "injection"
    strings:
        $api1 = "CreateRemoteThread" ascii wide
        $api2 = "WriteProcessMemory" ascii wide
        $api3 = "VirtualAllocEx" ascii wide
    condition:
        uint16(0) == 0x5A4D and all of them
}

rule Malicious_VBScript_Patterns {
    meta:
        description = "Detects suspicious VBScript patterns"
        severity = "medium"
        category = "script"
    strings:
        $wscript = "WScript.Shell" nocase ascii wide
        $exec = ".Run" nocase ascii wide
        $powershell = "powershell" nocase ascii wide
        $download = "MSXML2.XMLHTTP" nocase ascii wide
        $adodb = "ADODB.Stream" nocase ascii wide
    condition:
        $wscript and ($exec or $download) and any of ($powershell, $adodb)
}

rule Suspicious_Office_Macro {
    meta:
        description = "Detects suspicious Office macro patterns"
        severity = "high"
        category = "macro"
    strings:
        $auto1 = "AutoOpen" nocase ascii wide
        $auto2 = "Auto_Open" nocase ascii wide
        $auto3 = "Workbook_Open" nocase ascii wide
        $shell = "Shell" nocase ascii wide
        $createobject = "CreateObject" nocase ascii wide
        $wscript = "WScript.Shell" nocase ascii wide
    condition:
        any of ($auto*) and ($shell or ($createobject and $wscript))
}

rule Keylogger_Patterns {
    meta:
        description = "Detects potential keylogger behavior"
        severity = "critical"
        category = "keylogger"
    strings:
        $api1 = "GetAsyncKeyState" ascii wide
        $api2 = "GetKeyState" ascii wide
        $api3 = "SetWindowsHookEx" ascii wide
        $log = "log" nocase ascii wide
    condition:
        uint16(0) == 0x5A4D and 2 of ($api*) and $log
}

rule Ransomware_Extensions {
    meta:
        description = "Detects ransomware-related file extension patterns"
        severity = "critical"
        category = "ransomware"
    strings:
        $ext1 = ".encrypted" ascii wide
        $ext2 = ".locked" ascii wide
        $ext3 = ".crypto" ascii wide
        $msg1 = "bitcoin" nocase ascii wide
        $msg2 = "decrypt" nocase ascii wide
        $msg3 = "ransom" nocase ascii wide
    condition:
        any of ($ext*) and any of ($msg*)
}

rule WebShell_PHP {
    meta:
        description = "Detects potential PHP webshell"
        severity = "critical"
        category = "webshell"
    strings:
        $php = "<?php" ascii
        $eval = "eval(" nocase ascii
        $base64 = "base64_decode" nocase ascii
        $system = "system(" nocase ascii
        $exec = "exec(" nocase ascii
        $shell = "shell_exec(" nocase ascii
    condition:
        $php and ($eval or $base64) and any of ($system, $exec, $shell)
}

rule Network_Downloader {
    meta:
        description = "Detects download capabilities in executables"
        severity = "medium"
        category = "downloader"
    strings:
        $url1 = "URLDownloadToFile" ascii wide
        $url2 = "InternetOpenUrl" ascii wide
        $url3 = "InternetReadFile" ascii wide
        $wininet = "wininet.dll" nocase ascii wide
        $http = "http://" ascii wide
        $https = "https://" ascii wide
    condition:
        uint16(0) == 0x5A4D and any of ($url*) and ($wininet or $http or $https)
}

rule Crypto_Miner_Patterns {
    meta:
        description = "Detects cryptocurrency mining patterns"
        severity = "high"
        category = "cryptominer"
    strings:
        $pool1 = "stratum+tcp://" ascii wide
        $pool2 = "pool.supportxmr.com" ascii wide
        $pool3 = "monero" nocase ascii wide
        $algo1 = "cryptonight" nocase ascii wide
        $wallet = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ ascii  // Bitcoin address pattern
    condition:
        any of ($pool*) or ($algo1 and $wallet)
}
